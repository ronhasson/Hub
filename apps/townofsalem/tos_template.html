<template>
    <style>
        #cont {
            background-image: url("apps/townofsalem/village.jpg");
            height: 98vh;
            background-repeat: no-repeat;
            background-size: cover;
        }
    </style>
    <div style="
    -webkit-user-select: none;
    cursor: default;
">
        <span style="
    text-shadow: 0 1px 0 #ccc,                 0 2px 0 #c9c9c9,                 0 3px 0 #bbb,                 0 4px 0 #b9b9b9,                 0 5px 0 #aaa,                 0 6px 1px rgba(0,0,0,.1),                 0 0 5px rgba(0,0,0,.1),                 0 1px 3px rgba(0,0,0,.3),                 0 3px 5px rgba(0,0,0,.2),                 0 5px 10px rgba(0,0,0,.25),                 0 10px 10px rgba(0,0,0,.2),                 0 20px 20px rgba(0,0,0,.15);
    position: absolute;
    font-size: 8vh;
    left: 47vw;
    top: 17vh;
    opacity: 0.9;
">Town of Salem</span>
        <div style="
      height: 30vh;
      width: 33vw;
      z-index: 0;
      position: absolute;
      transform: rotateY(23deg)rotateX(-1deg) translateY(277px)translateX(170px);
      transform-style: preserve-3d;
      box-sizing: border-box;
      transform-origin: center center;
  ">
            <div style="
      height: 30vh;
      width: 33vw;
      z-index: 0;
      position: absolute;
      transform-origin: center center;
      background: none;
      background-color: #3ba029;
      border: black solid 2px;
  "></div>
            <div style="
      height: 55vh;
      width: 1vw;
      position: fixed;
      z-index: -1;
      background: linear-gradient(to left, rgb(241,224,245), #615d5d);
  "></div>
            <div style="
      background: linear-gradient(to left, rgb(241,224,245), #736f6f);
      height: 55vh;
      width: 1vw;
      float: right;
      z-index: -1;
      position: relative;
      right: 12px;
  "></div>
            <span style="
      z-index: 1;
      position: absolute;
      font-size: 5vh;
      transform-style: preserve-3d;
      margin: 14px;
  ">Town population</span>
            <div id="usersInGame" style="
z-index: 1;
position: absolute;
font-size: 3vh;
transform-style: preserve-3d;
margin: 14px;">

            </div>
            <div style="
      background-color: #30882f;
      height: 30vh;
      width: 2vw;
      z-index: 0;
      position: absolute;
      transform: rotateY(270deg) translateX(-42px);
      transform-origin: center left;
      transform-style: preserve-3d;
      border: black solid 1px;
  "></div>
            <div style="
      background-color: #0e7d00;
      height: 59vh;
      width: 2vw;
      z-index: 0;
      position: absolute;
      transform: rotateY(90deg)rotatex(90deg)translateY(618px) translateZ(317px)translateX(20px);
      transform-origin: center bottom;
      transform-style: preserve-3d;
      border: black solid;
  "></div>
            <div style="
      background-color: #30882f;
      height: 59vh;
      width: 2vw;
      z-index: 0;
      position: absolute;
      transform: rotateY(90deg)rotatex(90deg)translateY(615px) translateZ(642px)translateX(20px);
      transform-origin: center bottom;
      transform-style: preserve-3d;
      border: black solid;
  "></div>
            <span style="
      z-index: 1;
      position: absolute;
      font-size: 5vh;
      transform-style: preserve-3d;
      margin: 14px;
      transform: translateX(495px);
  ">0/7</span></div>
        <div onclick="start()" style="
      height: 13vh;
      width: 20vw;
      z-index: 0;
      position: absolute;
      transform: rotateY(-16deg)rotateX(-13deg)rotateZ(3deg) translateY(760px)translateX(976px);
      transform-style: preserve-3d;
      box-sizing: border-box;
      transform-origin: center center;
      cursor: pointer;
  ">
            <div style="
      height: 13vh;
      width: 20vw;
      z-index: 0;
      position: absolute;
      transform-origin: center center;
      background: none;
      background-color: #368efb;
      border: black solid 2px;
  "></div>


            <span style="
      z-index: 1;
      position: absolute;
      font-size: 5vh;
      transform-style: preserve-3d;
      transform: translateX(57px);
      font-size: 113px;
  ">Start</span>
            <div style="
      background-color: #3c85b9;
      height: 13vh;
      width: 2vw;
      z-index: 0;
      position: absolute;
      transform: rotateY(90deg) translateX(93px)translateZ(349px)scaleX(2.5);
      transform-origin: center right;
      transform-style: preserve-3d;
      border: black solid 1px;
  "></div>

            <div style="
      background-color: #65bcfb;
      height: 20vw;
      width: 2vw;
      z-index: 0;
      position: absolute;
      transform: rotateY(90deg)rotatex(90deg)translateY(366px) translateZ(386px)translateX(57px) scaleX(2.5);
      transform-origin: center bottom;
      transform-style: preserve-3d;
      border: black solid;
  "></div>
        </div>
    </div>
    <script>
        var rolePicker = require("./apps/townofsalem/rolePicker.js");
        var roles = require("./apps/townofsalem/roles.js");

        requestChangeRemotePage("tos");

        var players = [];
        var _roleList;

        var voteList = {};
        var guiltyVoters = [];
        var innoVoters = [];

        var playerOnTrial = null;
        var dayOne = false; //TODO: BACK TO TRUE YOU FOCKING FOCK

        var voteCounter = 0;
        var votingTimer = 30;
        var stopVotingTime = false;

        var inno = 0;
        var guilty = 0;

        var phase = "Discussion";

        var isDay = true;

        function discussion() {
            votingTimer = 30;
            voteCounter = 0;
            phase = "Discussion";
            var timer;
            if (dayOne)
                timer = 15;
            else
                timer = 5;
            sendEmit("changePhase", {
                time: timer,
                phase: "Discussion"
            });
            isDay = true;
            var interval = setInterval(function() {
                if (--timer < 0) {
                    clearInterval(interval);
                    if (dayOne) {
                        night();
                        dayOne = false;
                    } else {
                        voting();
                    }
                    return;
                }
            }, 1000);
        }

        function voting() { //everyone alive can vote
            phase = "Voting";
            sendEmit("changePhase", {
                time: votingTimer,
                phase: "Voting"
            });
            var interval = setInterval(function() {
                if (stopVotingTime) {
                    clearInterval(interval);
                    defense();
                    return;
                }
                if (--votingTimer < 0 || voteCounter > 6) {
                    clearInterval(interval);
                    night();
                    return;
                }
            }, 1000);
        }

        function defense() { //only trailled person can talk
            phase = "Defense";
            sendEmit("changePhase", {
                time: 20,
                phase: "Defense"
            });
            var timer = 20;
            var interval = setInterval(function() {
                if (--timer < 0) {
                    clearInterval(interval);
                    judgement();
                    return;
                }
            }, 1000);
        }

        function judgement() { //everyone alive can vote
            inno = 0;
            guilty = 0;
            phase = "Judgement";
            sendEmit("changePhase", {
                time: 20,
                phase: "Judgement",
                defendant: playerOnTrial.username
            });
            var timer = 20;
            var interval = setInterval(function() {
                if (--timer < 0) {
                    clearInterval(interval);
                    showJudgementResults();
                    if (guilty > inno) {
                        lastWords();
                    } else {
                        playerOnTrial = null;
                        stopVotingTime = false;
                        voting();
                    }
                    return;
                }
            }, 1000);
        }

        function lastWords() {
            phase = "Last Words";
            sendEmit("changePhase", {
                time: 5,
                phase: "Last Words"
            });
            var timer = 5;
            var interval = setInterval(function() {
                if (--timer < 0) {
                    clearInterval(interval);
                    hangPlayer();
                    night();
                    return;
                }
            }, 1000);
        }

        function night() {
            phase = "Night";
            sendEmit("changePhase", {
                time: 40,
                phase: "Night"
            });
            isDay = false;
            var timer = 40;
            var interval = setInterval(function() {
                if (--timer < 0) {
                    clearInterval(interval);
                    discussion();
                    return;
                }
            }, 1000);
        }

        function sendMessageToPlayers(data) { //ALWAYS USE THE NAME PROPERTY
            if (playerOnTrial == null || phase == "Judgement") {
                var sender_player = data.player;
                for (let index in players) {
                    let temp_player = players[index];
                    if (temp_player.socketid == sender_player.socketid)
                        sendToSocketId('getMessage', {
                            username: sender_player.username,
                            message: data.message
                        }, sender_player.socketid);
                    else if (!isDay) {
                        if (sender_player.isded) {
                            if (temp_player.isded)
                                sendToSocketId('getMessage', {
                                    username: sender_player.username,
                                    message: data.message
                                }, temp_player.socketid);
                            else if (temp_player.role.name == roles.Medium.name)
                                sendToSocketId('getMessage', {
                                    username: sender_player.username,
                                    message: data.message
                                }, temp_player.socketid);
                            else if (sender_player.role.name == roles.Medium.name && temp_player.Seancing == sender_player) //might need to compare usernames instead of comparing objects
                                sendToSocketId('getMessage', {
                                username: "Medium",
                                message: data.message
                            }, temp_player.socketid);
                        } else if (sender_player.Seancing == temp_player)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.name == roles.Medium.name && temp_player.isded)
                            sendToSocketId('getMessage', {
                                username: "Medium",
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.name == roles.Jailor.name && sender_player.inJail == temp_player)
                            sendToSocketId('getMessage', {
                                username: "Jailor",
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.inJail == temp_player && temp_player.role.name == roles.Jailor.name)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.team == "mafia" && temp_player.role.team == "mafia")
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.team == "mafia" && temp_player.role.name == roles.Spy.name)
                            sendToSocketId('getMessage', {
                                username: "Mafia",
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.name == roles.Vampire.name && temp_player.role.name == roles.Vampire.name)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.name == roles.Vampire.name && temp_player.role.name == roles.VampireHunter.name)
                            sendToSocketId('getMessage', {
                                username: "Vampire",
                                message: data.message
                            }, temp_player.socketid);
                    } else {
                        if (!sender_player.isded)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (temp_player.isded)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                    }
                }
            } else {
                if (playerOnTrial.username == data.player.username) {
                    sendEmit('getMessage', {
                        username: data.player.username,
                        message: data.message
                    });
                }
            }
        }

        function sendVotingMessage(username, targetUsername, message) {
            sendEmit('getVotingMessage', {
                message: username + message + targetUsername
            });
        }

        function Button1(data) {
            if (isDay) {
                if (phase == "Voting") { //voting
                    for (let uid in players) {
                        if (players[uid].username == data.targetname)   {
                            if (voteList[data.player.uid].votingTo == null) {
                                voteList[data.player.uid].votingTo = players[uid];
                                if (data.player.role.name == roles.Mayor.name) {
                                    voteList[uid].votesToMe += 3;
                                } else {
                                    voteList[uid].votesToMe++;
                                }
                                sendVotingMessage(data.player.username, data.targetname + ".", " has voted against ");
                            } else if (voteList[data.player.uid].votingTo.username != data.targetname) {
                                if (data.player.role.name == roles.Mayor.name) {
                                    voteList[uid].votesToMe += 3;
                                    voteList[voteList[data.player.uid].votingTo.uid].votesToMe -= 3;
                                } else {
                                    voteList[uid].votesToMe++;
                                    voteList[voteList[data.player.uid].votingTo.uid].votesToMe--;
                                }
                                voteList[data.player.uid].votingTo = players[uid];
                                sendVotingMessage(data.player.username, data.targetname + ".", " has changed their vote to ");
                            } else if (voteList[data.player.uid].votingTo.username == data.targetname) {
                                if (data.player.role.name == roles.Mayor.name) {
                                    voteList[uid].votesToMe -= 3;
                                } else {
                                    voteList[uid].votesToMe--;
                                }
                                voteList[data.player.uid].votingTo = null;
                                sendVotingMessage(data.player.username, "", " has canceled their vote.");
                            }
                            shouldGetOnTrial(uid);
                        }
                    }
                } else if (phase == "Judgement") { //judgement
                    var msg = "";
                    if (guiltyVoters.indexOf(data.player.username) == -1) {
                        msg = " has voted.";
                        guilty++;
                        guiltyVoters.push(data.player.username);
                        if(innoVoters.indexOf(data.player.username) != -1) {
                            innoVoters.splice(innoVoters.indexOf(data.player.username), 1);
                            msg = " has changed their vote.";
                        }
                    } else {
                        msg = " has canceled their vote.";
                        guilty--;
                        guiltyVoters.splice(guiltyVoters.indexOf(data.player.username), 1);
                    }
                    sendVotingMessage(data.player.username, "", msg);
                }
            } else { //night

            }
        }

        function Button2(data) {
            if (isDay) {
                if (phase == "Judgement") {
                    var msg = "";
                    if (innoVoters.indexOf(data.player.username) == -1) {
                        msg = " has voted.";
                        inno++;
                        innoVoters.push(data.player.username);
                        if(guiltyVoters.indexOf(data.player.username) != -1) {
                            guiltyVoters.splice(guiltyVoters.indexOf(data.player.username), 1);
                            msg = " has changed their vote.";
                        }
                    } else {
                        inno--;
                        innoVoters.splice(innoVoters.indexOf(data.player.username), 1);
                        msg = " has canceled their vote.";
                    }
                    sendVotingMessage(data.player.username, "", msg);
                }
            } else { //night

            }
        }

        function shouldGetOnTrial(playerUID) {
            var playersAlive = 0;
            for (let uid in players) {
                if (!players[uid].isded) {
                    playersAlive++;
                }
            }
            if (voteList[playerUID].votesToMe > (playersAlive / 2)) {
                voteCounter++;
                stopVotingTime = true;
                playerOnTrial = players[playerUID];
                for (let uid in voteList) {
                    voteList[uid].votesToMe = 0;
                    voteList[uid].votingTo = null;
                }
                console.log("on trial baby: " + playerOnTrial.username);
                // go on trial
            }
        }

        function showJudgementResults() {
            for (var i = 0; i < innoVoters.length; i++) {
                sendVotingMessage(innoVoters[i], "", " voted innocent.");
            }
            for (var i = 0; i < guiltyVoters.length; i++) {
                sendVotingMessage(guiltyVoters[i], "", " voted guilty.");
            }
            for (let uid in players) {
                if (guiltyVoters.indexOf(players[uid].username) == -1 && innoVoters.indexOf(players[uid].username) == -1 && playerOnTrial.username != players[uid].username) {
                    sendVotingMessage(players[uid].username, "", " abstained.");
                }
            }
            guiltyVoters = [];
            innoVoters = [];
        }

        function hangPlayer() {
            console.log("about to fucking die baby: " + playerOnTrial.username);
            playerOnTrial.isded = true;

            // show msg "ditza" has died.
            // show will and role
            // put in graveyard (2 buttons will and deathnote)
            playerOnTrial = null;
        }

        function start() {
            for (let index in players) {
                if(players[index].username == "") {
                    delete players[index];
                }
            }
            /*for (let uid in players) {
                let player = players[uid];
                if (player.username == "") {
                    delete players[uid];
                }
            }*/
            
            _roleList = rolePicker.getRoles(Object.keys(players).length);
            _roleList = rolePicker.checkValidation(_roleList);
            console.log("s start - ");
            console.log(_roleList);
            var shuffledRoleList = _roleList.shuffle();
            var i = 0;
            var mafList = [];
            var vampList = [];
            var _nameList = [];
            for (let index in players) {
                players[index].role = shuffledRoleList[i];
                var voteInfo = new Object();
                voteInfo.votingTo = null;
                voteInfo.votesToMe = 0;
                voteList[index] = voteInfo;
                if(players[index].role.team == "mafia") {
                    mafList.push(players[index]);
                }
                else if(players[index].role.name == roles.Vampire.name) {
                    vampList.push(players[index]);
                }
                _nameList.push(players[index].username);
                i++;
            }
            for (let index in players) {
                if(players[index].role.team == "mafia") {
                    players[index].mafiaList = mafList;
                }
                else if(players[index].role.name == roles.Vampire.name) {
                    players[index].vampireList = vampList;
                }
                players.nameList = _nameList;
            }
            /*var i = 0;
            for (let uid in players) {
                players[uid].role = _roleList[i];
                var voteInfo = new Object();
                voteInfo.votingTo = null;
                voteInfo.votesToMe = 0;
                voteList[uid] = voteInfo;
                i++;
            }*/
            console.log("start - ");
            console.log(players);
            for (let index in players) {
                sendToSocketId("startGame", {
                    player: players[index]
                }, players[index].socketid);
            }
            discussion();
        }

        Array.prototype.shuffle = function() {
            var input = this;

            for (var i = input.length - 1; i >= 0; i--) {

                var randomIndex = Math.floor(Math.random() * (i + 1));
                var itemAtIndex = input[randomIndex];

                input[randomIndex] = input[i];
                input[i] = itemAtIndex;
            }
            return input;
        }

        function addPlayer(uid, socketid) {
            var p = new Player(uid, socketid);
            p.roleList = _roleList;
            players.push(p);
        }

        class Player {
            roleList: roles.Role[] = []; //error is here: "unexpected token :"
            nameList: string[] = [];
            username: string = "";
            role: roles.Role;
            isDead: boolean = false;
            uid: string;
            socketid: string;
            roleBlocked: boolean = false; //check if needed
            blackmailed: boolean = false;
            jailed: boolean = false;
            cleaned: boolean = false;
            framed: boolean = false;
            abilityCounter: number = 0;
            targetPlayer: string = "";
            will: string = ""; //check if needed + deathnote
            //add priority
            constructor(_uid: string, _socketid: string) {
                this.uid = _uid;
                this.socketid = _socketid;
            }
        }

        class Jailor extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Medium extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Transporter extends Player {
            target2: string = ""; //for button2
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Witch extends Player {
            target2: string = "";
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Veteran extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Escort extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Consort extends Player {
            mafiaList: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Doctor extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Janitor extends Player {
            mafiaList: Player[];
            cleanedPlayers: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Retributionist extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Forger extends Player {
            mafiaList: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Consigliere extends Player {
            mafiaList: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Blackmailer extends Player {
            mafiaList: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Framer extends Player {
            mafiaList: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Bodyguard extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Godfather extends Player {
            mafiaList: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Mafioso extends Player {
            mafiaList: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class SerialKiller extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class VampireHunter extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Jester extends Player {
            diedAtNight: boolean; // set when dead
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Vigilante extends Player {
            willDie: boolean = false; //if kills town
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Disguiser extends Player {
            mafiaList: Player[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Amnesiac extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Arsonist extends Player {
            dousedTargets: string[];
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Survivor extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Sheriff extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Lookout extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Investigator extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Vampire extends Player {
            vampireList: Player[];
            youngest: boolean = false;
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        class Werewolf extends Player {
            constructor(_uid: string, _socketid: string) {
                super(_uid, _socketid);
            }
        }

        function checkUserName(data) {
            //console.log(players);
            for (let uid in players) {
                let player = players[uid];
                //console.log(player);
                if (player.username == data.usr) {
                    sendEmit("requestUserNCallBack", {
                        flag: true,
                        usr: data.usr,
                        uid: data.uid
                    });
                    return false;
                }
            }
            //console.log("pass - " +players[data.uid]);
            players[data.uid].username = data.usr;
            sendEmit("requestUserNCallBack", {
                flag: false,
                usr: data.usr,
                uid: data.uid
            });
            displayUsers();
            //console.log(players);
        }

        function displayUsers() {
            var disp = document.getElementById("usersInGame");
            disp.innerHTML = "";
            for (var uid in players) {
                let player = players[uid];
                if (player.username != "") {
                    disp.innerHTML += "<a class='playerWait' onclick='removePlayer(\"" + uid + "\")'>" + player.username + "</a></br>";
                }
            }
        }

        function removePlayer(uid) {
            players[uid].username = "";
            displayUsers();
        }

        
    </script>
</template>
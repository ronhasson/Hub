<template>

    <center>
        <h1></h1>
        <input type="button" value="Start!" onclick="start()" />
        <div id="usersInGame">
        </div>
    </center>
    <script>
        var rolePicker = require("./apps/townofsalem/rolePicker.js");
        var roles = require("./apps/townofsalem/roles.js");
        var tos = require("./apps/townofsalem/tosGame.js");

        requestChangeRemotePage("tos");
        var players = {};

        var voteInfo = new Object();
        voteInfo.votingTo = null;
        voteInfo.votesToMe = 0;
        var voteList = {};
        var guiltyVoters = [];
        var innoVoters = [];
        var playerOnTrial = null;

        isDay = false;

        function sendMessageToPlayers(data) { //ALWAYS USE THE NAME PROPERTY
            if (tos.playerOnTrial == null) {
                var sender_player = data.player;
                for (let uid in players) {
                    let temp_player = players[uid];
                    if (temp_player.socketid == sender_player.socketid)
                        sendToSocketId('getMessage', {
                            username: sender_player.username,
                            message: data.message
                        }, sender_player.socketid);
                    else if (!isDay) {
                        if (sender_player.isded) {
                            if (temp_player.isded)
                                sendToSocketId('getMessage', {
                                    username: sender_player.username,
                                    message: data.message
                                }, temp_player.socketid);
                            else if (temp_player.role.name == roles.Medium.name)
                                sendToSocketId('getMessage', {
                                    username: sender_player.username,
                                    message: data.message
                                }, temp_player.socketid);
                            else if (sender_player.role.name == roles.Medium.name && temp_player.Seancing == sender_player) //might need to compare usernames instead of comparing objects
                                sendToSocketId('getMessage', {
                                username: "Medium",
                                message: data.message
                            }, temp_player.socketid);
                        } else if (sender_player.Seancing == temp_player)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.name == roles.Medium.name && temp_player.isded)
                            sendToSocketId('getMessage', {
                                username: "Medium",
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.name == roles.Jailor.name && sender_player.inJail == temp_player)
                            sendToSocketId('getMessage', {
                                username: "Jailor",
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.inJail == temp_player && temp_player.role.name == roles.Jailor.name)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.team == "mafia" && temp_player.role.team == "mafia")
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.team == "mafia" && temp_player.role.name == roles.Spy.name)
                            sendToSocketId('getMessage', {
                                username: "Mafia",
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.name == roles.Vampire.name && temp_player.role.name == roles.Vampire.name)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (sender_player.role.name == roles.Vampire.name && temp_player.role.name == roles.VampireHunter.name)
                            sendToSocketId('getMessage', {
                                username: "Vampire",
                                message: data.message
                            }, temp_player.socketid);
                    } else {
                        if (!sender_player.isded)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                        else if (temp_player.isded)
                            sendToSocketId('getMessage', {
                                username: sender_player.username,
                                message: data.message
                            }, temp_player.socketid);
                    }
                }
            } else {
                if (tos.playerOnTrial == data.player) {
                    sendEmit('getMessage', {
                        username: data.player.username,
                        message: data.message
                    });
                }
            }
        }

        function sendVotingMessage(username, targetUsername, message) {
            sendEmit('getVotingMessage', {
                message: username + message + targetUsername
            });
        }

        function Button1(data) {
            if (isDay) {
                if (tos.phase == "Voting") { //voting
                    for (let uid in players) {
                        if (players[uid].username == data.targetname) {
                            if (voteList[data.player.uid].votingTo == null) {
                                voteList[data.player.uid].votingTo = players[uid];
                                if (players[data.player.uid].role == roles.Mayor) {
                                    voteList[uid].votesToMe += 3;
                                } else {
                                    voteList[uid].votesToMe++;
                                }
                                sendVotingMessage(data.player.username, data.targetname + ".", " has voted against ");
                            } else if (voteList[data.player.uid].votingTo.username != data.targetname) {
                                if (players[data.player.uid].role == roles.Mayor) {
                                    voteList[uid].votesToMe += 3;
                                    voteList[voteList[data.player.uid].votingTo.uid].votesToMe -= 3;
                                } else {
                                    voteList[uid].votesToMe++;
                                    voteList[voteList[data.player.uid].votingTo.uid].votesToMe--;
                                }
                                voteList[data.player.uid].votingTo = players[uid];
                                sendVotingMessage(data.player.username, data.targetname + ".", " has changed their vote to ");
                            } else if (voteList[data.player.uid].votingTo.username == data.targetname) {
                                if (players[data.player.uid].role == roles.Mayor) {
                                    voteList[uid].votesToMe -= 3;
                                } else {
                                    voteList[uid].votesToMe--;
                                }
                                voteList[data.player.uid].votingTo = null;
                                sendVotingMessage(data.player.username, "", " has canceled their vote.");
                            }
                            shouldGetOnTrial(uid);
                        }
                    }
                } else if (tos.phase == "Judgement") { //judgement
                    if (guiltyVoters.indexOf(data.player.username) == -1) {
                        tos.guilty++;
                        sendVotingMessage(data.player.username, "", " has voted.");
                        guiltyVoters.push(data.player.username);
                    } else {
                        tos.guilty--;
                        sendVotingMessage(data.player.username, "", " has canceled their vote.");
                        var temp = -1;
                        for (var i = 0; i < guiltyVoters.length; i++) {
                            if (guiltyVoters[i] == data.player.username) {
                                temp = i;
                            }
                        }
                        guiltyVoters.splice(temp, 1);
                    }
                }
            } else { //night

            }
        }

        function Button2(data) {
            if (isDay) {
                if (tos.phase == "Judgement") {
                    if (innoVoters.indexOf(data.player.username) == -1) {
                        tos.inno++;
                        sendVotingMessage(data.player.username, "", " has voted.");
                        innoVoters.push(data.player.username);
                    } else {
                        tos.inno--;
                        sendVotingMessage(data.player.username, "", " has canceled their vote.");
                        var temp = -1;
                        for (var i = 0; i < innoVoters.length; i++) {
                            if (innoVoters[i] == data.player.username) {
                                temp = i;
                            }
                        }
                        innoVoters.splice(temp, 1);
                    }
                }
            } else { //night

            }
        }

        function shouldGetOnTrial(playerUID) {
            var playersAlive = 0;
            for (let uid in players) {
                if (!players[uid].isded) {
                    playersAlive++;
                }
            }
            if (voteList[playerUID].votesToMe > (playersAlive / 2)) {
                tos.voteCounter++;
                tos.stopVotingTime = true;
                tos.playerOnTrial = players[playerUID];
                playerOnTrial = players[playerUID];
                for (let uid in voteList) {
                    voteList[uid].votesToMe = 0;
                    voteList[uid].votingTo = null;
                }
                // go on trial
            }
        }

        function showJudgementResults() {
            for (var i = 0; i < innoVoters.length; i++) {
                sendVotingMessage(innoVoters[i], "", " voted innocent.");
            }
            for (var i = 0; i < guiltyVoters.length; i++) {
                sendVotingMessage(guiltyVoters[i], "", " voted guilty.");
            }
            for (let uid in players) {
                if (guiltyVoters.indexOf(players[uid].username) == -1 && innoVoters.indexOf(players[uid].username) == -1) {
                    sendVotingMessage(players[uid].username, "", " abstained.");
                }
            }
        }

        function hangPlayer() {
            playerOnTrial.isded = true;
            // show will and role
            // put in graveyard
            playerOnTrial = null;
        }

        function start() {
            for (let uid in players) {
                let player = players[uid];
                if (player.username == "") {
                    delete players[uid];
                }
            }
            var roleList;
            roleList = rolePicker.getRoles(Object.keys(players).length);
            roleList = rolePicker.checkValidation(roleList);
            console.log("s start - ");
            console.log(roleList);
            roleList.shuffle();
            var i = 0;
            for (let uid in players) {
                players[uid].role = roleList[i];
                voteList[uid] = voteInfo;
                i++;
            }
            console.log("start - ");
            console.log(players);
            SendMafia();
            SendVampires();
            SendNames();
            for (let uid in players) {
                sendToSocketId("startGame", {
                    player: players[uid]
                }, players[uid].socketid);
            }

            tos.discussion();
        }

        function SendMafia() {
            var tempmafia_list = {};
            var socketidlist = {};
            for (let uid in players) {
                if (players[uid].role.team == "mafia") {
                    tempmafia_list[uid] = players[uid];
                    socketidlist[uid] = players[uid].socketid;
                }
            }
            sendToSocketIDList("getMafia", socketidlist, {
                mafiaList: tempmafia_list
            });
        }

        function SendVampires() {
            var tempvampires_list = {};
            var socketidlist = {};
            for (let uid in players) {
                if (players[uid].role == roles.Vampire) {
                    tempvampires_list[uid] = players[uid];
                    socketidlist[uid] = players[uid].socketid;
                }
            }
            sendToSocketIDList("getVampires", socketidlist, {
                vampireList: tempvampires_list
            });
        }

        function SendNames() {
            var name_list = {};
            var socketidlist = {};
            for (let uid in players) {
                name_list[uid] = players[uid].username;
                socketidlist[uid] = players[uid].socketid;
            }
            sendToSocketIDList("getNames", socketidlist, {
                nameList: name_list
            });
        }

        Array.prototype.shuffle = function() {
            var input = this;

            for (var i = input.length - 1; i >= 0; i--) {

                var randomIndex = Math.floor(Math.random() * (i + 1));
                var itemAtIndex = input[randomIndex];

                input[randomIndex] = input[i];
                input[i] = itemAtIndex;
            }
            return input;
        }

        function addPlayer(uid, socketid, id) {
            var player = new Object();
            player.Seancing = null; //will contain the playing you're curently seancing
            player.inJail = null;
            player.username = "";
            player.role = "";
            player.abilitycounter = 0; //only ++ when ability counter is limited
            player.isded = false;
            player.socketid = socketid;
            players[uid] = player;
            sendEmit("getRoles", roles);
            //console.log("add player - " + player);
        }

        function checkUserName(data) {
            //console.log(players);
            for (let uid in players) {
                let player = players[uid];
                //console.log(player);
                if (player.username == data.usr) {
                    sendEmit("requestUserNCallBack", {
                        flag: true,
                        usr: data.usr,
                        uid: data.uid
                    });
                    return false;
                }
            }
            //console.log("pass - " +players[data.uid]);
            players[data.uid].username = data.usr;
            sendEmit("requestUserNCallBack", {
                flag: false,
                usr: data.usr,
                uid: data.uid
            });
            displayUsers();
            //console.log(players);
        }

        function displayUsers() {
            var disp = document.getElementById("usersInGame");
            disp.innerHTML = "";
            for (var uid in players) {
                let player = players[uid];
                if (player.username != "") {
                    disp.innerHTML += "<a class='playerWait' onclick='removePlayer(\"" + uid + "\")'>" + player.username + "</a></br>";
                }
            }
        }

        function removePlayer(uid) {
            players[uid].username = "";
            displayUsers();
        }

        module.exports = {
            hangPlayer: hangPlayer,
            showJudgementResults: showJudgementResults
        };
    </script>
</template>

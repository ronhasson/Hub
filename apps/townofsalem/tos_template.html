<template>

    <center>
        <h1></h1>
        <input type="button" value="Start!" onclick="start()" />
        <div id="usersInGame">
        </div>
    </center>
    <script>
        var rolePicker = require("./apps/townofsalem/rolePicker.js");
        var roles = require("./apps/townofsalem/roles.js");
        var tos = require("./apps/townofsalem/tosGame.js");

        requestChangeRemotePage("tos");
        var players = {};
        isDay = false;

        function sendMessageToPlayers(data){ //ALWAYS USE THE NAME PROPERTY
          var sender_player = data.player;
            for (let uid in players) {
                let temp_player = players[uid];
                if(temp_player.socketid == sender_player.socketid)
                    sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, sender_player.socketid);
                else if(!isDay)
                {
                    if(sender_player.isded)
                    {
                        if(temp_player.isded)
                            sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, temp_player.socketid);
                        else if(temp_player.role.name == roles.Medium.name)
                            sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, temp_player.socketid);
                        else if(sender_player.role.name == roles.Medium.name && temp_player.Seancing == sender_player) //might need to compare usernames instead of comparing objects
                            sendToSocketId('getMessage', {username : "Medium", message : data.message}, temp_player.socketid);
                    }
                    else if(sender_player.Seancing == temp_player)
                        sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, temp_player.socketid);
                    else if(sender_player.role.name == roles.Medium.name && temp_player.isded)
                        sendToSocketId('getMessage', {username : "Medium", message : data.message}, temp_player.socketid);
                    else if(sender_player.role.name == roles.Jailor.name && sender_player.inJail == temp_player)
                        sendToSocketId('getMessage', {username : "Jailor", message : data.message}, temp_player.socketid);
                    else if(sender_player.inJail == temp_player && temp_player.role.name == roles.Jailor.name)
                        sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, temp_player.socketid);
                    else if(sender_player.role.team == "mafia" && temp_player.role.team == "mafia")
                        sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, temp_player.socketid);
                    else if(sender_player.role.team == "mafia" && temp_player.role.name == roles.Spy.name)
                        sendToSocketId('getMessage', {username : "Mafia", message : data.message}, temp_player.socketid);
                    else if(sender_player.role.name == roles.Vampire.name && temp_player.role.name == roles.Vampire.name)
                        sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, temp_player.socketid);
                    else if(sender_player.role.name == roles.Vampire.name && temp_player.role.name == roles.VampireHunter.name)
                        sendToSocketId('getMessage', {username : "Vampire", message : data.message}, temp_player.socketid);
                }
                else
                {
                    if(!sender_player.isded)
                        sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, temp_player.socketid);
                    else if(temp_player.isded)
                        sendToSocketId('getMessage', {username : sender_player.username, message : data.message}, temp_player.socketid);
                }
            }
        }

        function Button1(data)
        {
            if(isDay)
            {
                //voting

            }
        }

        

        function start() {
            for (let uid in players) {
                let player = players[uid];
                if (player.username == "") {
                    delete players[uid];
                }
            }
            var roleList;
            roleList = rolePicker.getRoles(Object.keys(players).length);
            roleList = rolePicker.checkValidation(roleList);
            console.log("s start - ");
            console.log(roleList);
            roleList.shuffle();
            var i = 0;
            for (let uid in players) {
                players[uid].role = roleList[i];
                i++;
            }
            console.log("start - ");
            console.log(players);
            SendMafia();
            SendVampires();
            SendNames();
            for (let uid in players) {
                sendToSocketId("startGame", {player : players[uid]}, players[uid].socketid);
            }

            tos.discussion();
        }

        function SendMafia()
        {
            var tempmafia_list = {};
            var socketidlist = {};
            for (let uid in players) {
                if(players[uid].role.team == "mafia")
                {
                    tempmafia_list[uid] = players[uid];
                    socketidlist[uid] = players[uid].socketid;
                }
            }
            sendToSocketIDList("getMafia", socketidlist, {mafiaList : tempmafia_list});
        }

        function SendVampires()
        {
            var tempvampires_list = {};
            var socketidlist = {};
            for (let uid in players) {
                if(players[uid].role == roles.Vampire)
                {
                    tempvampires_list[uid] = players[uid];
                    socketidlist[uid] = players[uid].socketid;
                }
            }
            sendToSocketIDList("getVampires", socketidlist, {vampireList : tempvampires_list});
        }

        function SendNames()
        {
            var name_list = {};
            var socketidlist = {};
            for (let uid in players) {
                name_list[uid] = players[uid].username;
                socketidlist[uid] = players[uid].socketid;
            }
            sendToSocketIDList("getNames", socketidlist, {nameList : name_list});
        }

        Array.prototype.shuffle = function() {
            var input = this;

            for (var i = input.length - 1; i >= 0; i--) {

                var randomIndex = Math.floor(Math.random() * (i + 1));
                var itemAtIndex = input[randomIndex];

                input[randomIndex] = input[i];
                input[i] = itemAtIndex;
            }
            return input;
        }

        function addPlayer(uid, socketid) {
            var player = new Object();
            player.Seancing = null; //will contain the playing you're curently seancing
            player.inJail = null;
            player.username = "";
            player.role = "";
            player.abilitycounter = 0; //only ++ when ability counter is limited
            player.isded = false;
            player.socketid = socketid;
            players[uid] = player;
            sendEmit("getRoles", roles);
            //console.log("add player - " + player);
        }



        function checkUserName(data) {
            //console.log(players);
            for (let uid in players) {
                let player = players[uid];
                //console.log(player);
                if (player.username == data.usr) {
                    sendEmit("requestUserNCallBack", {
                        flag: true,
                        usr: data.usr,
                        uid: data.uid
                    });
                    return false;
                }
            }
            //console.log("pass - " +players[data.uid]);
            players[data.uid].username = data.usr;
            sendEmit("requestUserNCallBack", {
                flag: false,
                usr: data.usr,
                uid: data.uid
            });
            displayUsers();
            //console.log(players);
        }

        function displayUsers() {
            var disp = document.getElementById("usersInGame");
            disp.innerHTML = "";
            for (var uid in players) {
                let player = players[uid];
                if (player.username != "") {
                    disp.innerHTML += "<a class='playerWait' onclick='removePlayer(\"" + uid + "\")'>" + player.username + "</a></br>";
                }
            }
        }

        function removePlayer(uid) {
            players[uid].username = "";
            displayUsers();
        }
    </script>
</template>

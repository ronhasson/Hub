<template>

    <center>
        <h1></h1>
        <input type="button" value="Start!" onclick="start()" />
        <div id="usersInGame">

        </div>
    </center>
    <script>
        var rolePicker = require("./apps/townofsalem/rolePicker.js");
        var roles = require("./apps/townofsalem/roles.js");
        var tos = require("./apps/townofsalem/tosGame.js");

        requestChangeRemotePage("tos");
        var players = {};
        isDay = false;


        function sendMessageToPlayers(data){
          //sendEmit('getMessage', data);
          socketidlist = [];
          var sender_player = data.player;
            for (let uid in players) {
                let temp_player = players[uid];
                if(!isDay)
                {
                    if(sender_player.isded)
                    {
                        if(temp_player.isded)
                            socketidlist.push(temp_player.socketid);
                        else if(temp_player.role == roles.Medium)
                            socketidlist.push(temp_player.socketid);
                        else if(sender_player.role == roles.Medium && temp_player.Seancing == sender_player)
                        {
                            sender_player.username = "Medium";
                            socketidlist.push(temp_player.socketid);
                        }
                    }
                    else if(sender_player.Seancing == temp_player)
                        socketidlist.push(temp_player.socketid);
                    else if(sender_player.role == roles.Medium && temp_player.isded)
                    {
                        sender_player.username = "Medium";
                        socketidlist.push(temp_player.socketid);
                    }
                    else if(sender_player.role == roles.Jailor && temp_player.isJailed)
                    {
                        sender_player.username = "Jailor";
                        socketidlist.push(temp_player.socketid);
                    }
                    else if(sender_player.isJailed && temp_player.role == roles.Jailor)
                        socketidlist.push(temp_player.socketid);
                    else if(sender_player.role.team == "mafia" && temp_player.role.team == "mafia")
                        socketidlist.push(temp_player.socketid);
                    else if(sender_player.role.team == "mafia" && temp_player.role == roles.Spy)
                    {
                        sender_player.username = "Mafia";
                        socketidlist.push(temp_player.socketid);
                    }
                    else if(sender_player.role == roles.Vampire && temp_player.role == roles.Vampire)
                        socketidlist.push(temp_player.socketid);
                }
                else 
                {
                    if(!sender_player.isded)
                        socketidlist.push(temp_player.socketid);
                    else if(temp_player.isded)
                        socketidlist.push(temp_player.socketid);
                }
            }
        data.player = sender_player;
        sendToIpList('getMessage', socketidlist, data.username, data.message);
        }

        function FilterPlayers(player){
            
        }

        function start() {
            for (let uid in players) {
                let player = players[uid];
                if (player.username == "") {
                    delete players[uid];
                }
            }
            var roleList;
            roleList = rolePicker.getRoles(Object.keys(players).length);
            roleList = rolePicker.checkValidation(roleList);
            console.log("s start - ");
            console.log(roleList);
            roleList.shuffle();
            var i = 0;
            for (let uid in players) {
                players[uid].role = roleList[i];
                i++;
            }
            console.log("start - ");
            console.log(players);

            sendEmit("startGame", players);
            tos.discussion();
        }

        Array.prototype.shuffle = function() {
            var input = this;

            for (var i = input.length - 1; i >= 0; i--) {

                var randomIndex = Math.floor(Math.random() * (i + 1));
                var itemAtIndex = input[randomIndex];

                input[randomIndex] = input[i];
                input[i] = itemAtIndex;
            }
            return input;
        }

        function addPlayer(uid, socketid) {
            var player = new Object();
            player.Seancing = null; //will contain the playing you're curently seancing
            player.isJailed = false;
            player.username = "";
            player.role = "";
            player.abilitycounter = 0; //only ++ when ability counter is limited
            player.isded = false;
            player.socketid = socketid;
            players[uid] = player;
            sendEmit("getRoles", roles);
            //console.log("add player - " + player);
        }



        function checkUserName(data) {
            //console.log(players);
            for (let uid in players) {
                let player = players[uid];
                //console.log(player);
                if (player.username == data.usr) {
                    sendEmit("requestUserNCallBack", {
                        flag: true,
                        usr: data.usr,
                        uid: data.uid
                    });
                    return false;
                }
            }
            //console.log("pass - " +players[data.uid]);
            players[data.uid].username = data.usr;
            sendEmit("requestUserNCallBack", {
                flag: false,
                usr: data.usr,
                uid: data.uid
            });
            displayUsers();
            //console.log(players);
        }

        function displayUsers() {
            var disp = document.getElementById("usersInGame");
            disp.innerHTML = "";
            for (var uid in players) {
                let player = players[uid];
                if (player.username != "") {
                    disp.innerHTML += "<a class='playerWait' onclick='removePlayer(\"" + uid + "\")'>" + player.username + "</a></br>";
                }
            }
        }

        function removePlayer(uid) {
            players[uid].username = "";
            displayUsers();
        }
    </script>
</template>